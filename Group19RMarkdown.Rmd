---
title: "BIOSTAT 650 Project"
author: "Jaehoon Kim"
date: "2024-11-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("sas7bdat")
library("corrplot")
library("gtsummary")
library("dplyr")
library("ggplot2")
library("data.table")
library("car")
library("NHANES")
```




```{r datasetup 1}
df = NHANES

```

```{r EDA}
covariates = c("SexAge","Gender","HHIncome","Education","PhysActive","SameSex","AlcoholYear","RegularMarij","HardDrugs")
sapply(df[, covariates], is.factor)
#M = cor(df[, covariates])
#corrplot(M, method = 'number')
```


```{r datasetup 2}
df = NHANES
#df = NHANES["DiabetesAge" > 20]
colnames(df)
scatmatrixData = df[,c("SexAge", "HardDrugs", "RegularMarij")]
panel.hist <- function(x, ...)
{
usr <- par("usr"); on.exit(par(usr))
par(usr = c(usr[1:2], 0, 1.5) )
h <- hist(x, plot = FALSE)
breaks <- h$breaks; nB <- length(breaks)
y <- h$counts; y <- y/max(y)
rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
pairs(scatmatrixData, pch = 19, diag.panel=panel.hist)


```

```{r model}
model <- lm(DiabetesAge ~ Gender+Poverty+BMI+BPSys1+SleepHrsNight+PhysActiveDays, df)
summary(model)
```

```{r model 2}
model <- lm(BPSys1 ~ Age+Gender+Poverty+BMI+SleepHrsNight+PhysActiveDays+SmokeNow+AlcoholYear+HardDrugs, df)
summary(model)

```

```{r model 3}
model <- lm(SexAge ~ Depressed+LittleInterest+HealthGen+Gender+HHIncome+Education+PhysActive+RegularMarij+HardDrugs+RegularMarij*HardDrugs+Depressed*HardDrugs+SmokeAge, df)
summary(model)
model <- lm(SexAge ~ RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
summary(model)
```

```{r model 3-1}
model <- lm(SexAge ~ Gender+HHIncome+Education+SameSex+PhysActive+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
summary(model)
```

```{r model 4}
model <- lm(SexNumPartnLife ~ Gender+HHIncome+Education+PhysActive+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
summary(model)
```

```{r model 5}
model <- lm(SexNumPartnLife ~ Gender+HHIncome+Education+PhysActive+SameSex+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
summary(model)
```

Created new variable and log transformed due to extreme skewness
```{R New variable}
hist(df$SexAge)
sort(unique(df$SexAge))
typeof(df$SexAge)
subset(df, SexAge == 9 & !is.na(SexAge))$SexNumPartnLife
hist(df$SexNumPartYear)
hist(df$SexNumPartYear[df$SexNumPartYear < 20])
sort(unique(df$SexNumPartYear))

hist(df$SexNumPartnLife)
hist(df$SexNumPartnLife[df$SexNumPartnLife < 30])

unique(df$SexAge)
df = mutate(df, AvgSexFreq = log((Age-SexAge)/SexNumPartnLife))
hist(df$AvgSexFreq)
boxplot(df$AvgSexFreq)
```

```{R New variable test}
df$AvgSexFreq[is.infinite(df$AvgSexFreq)] = NA
#unique(df$AvgSexFreq)

model <- lm(AvgSexFreq ~ Gender+HHIncome+Education+PhysActive+SameSex+AlcoholYear+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
summary(model)

#model <- lm(AvgSexFreq ~ #Gender+HHIncome+Education+PhysActive+SameSex+AlcoholYear+RegularMarij+HardDrugs+#RegularMarij*HardDrugs+RegularMarij*AlcoholYear, df)
#summary(model)

```
```{r systematic differences of missing values}

library(ggplot2)
library(tidyr)
completedf = df[is.na(df$AvgSexFreq),]
incompletedf = df[!is.na(df$AvgSexFreq),]
#Add new column based on missingness
df$missingness <- ifelse(is.na(df$AvgSexFreq), "Missing", "Not Missing")
covariates = c("Gender","HHIncome","Education","PhysActive","SameSex","AlcoholYear","RegularMarij","HardDrugs")

A = hist(completedf$AlcoholYear)
B = hist(incompletedf$AlcoholYear)

plot(A, col = "red")
plot(B, col = "white", add = TRUE)

hist(df$AlcoholYear)

```
```{r missigness graphs}
library(gridExtra)
p1 = ggplot(data = df, mapping=aes(x=AlcoholYear, fill=as.factor(missingness)))+
  geom_bar(stat="count")+
  scale_fill_manual(values = c("gray", "red"))
p2 = ggplot(data = df, mapping=aes(x=Education, fill=as.factor(missingness)))+
  geom_bar(stat="count")+
  scale_fill_manual(values = c("gray", "red"))

grid.arrange(p1,p2,nrow=1)
```


```{r Partial SS}
library(car)
car::Anova(lm(AvgSexFreq ~ Gender+HHIncome+Education+PhysActive+SameSex+AlcoholYear+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df), type="III")


```


```{r QQplot}

m1 = lm(AvgSexFreq ~ Gender+HHIncome+Education+PhysActive+SameSex+AlcoholYear+RegularMarij+HardDrugs+RegularMarij*HardDrugs, df)
m1.res = m1$residuals

car::qqPlot(m1.res)
```

```{r avPlots}

car::avPlots(m1)
```

```{r Residual Plots}


car::residualPlots(m1, type="response")
```

```{r multicolinearity}
#interactions(???)
car::vif(m1, type = 'predictor')
```